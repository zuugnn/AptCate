<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>jQuery Cascading Dropdown Plugin Examples</title>
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width" />

        <!-- Stylesheets here -->
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.0/css/bootstrap.min.css" />
        <style type="text/css">
            .b-docs-example {
                position: relative;
                margin: 15px 0;
                padding: 39px 19px 14px;
                background-color: #fff;
                border: 1px solid #ddd;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
            }

            .b-docs-example:after {
                content: "Example";
                position: absolute;
                top: -1px;
                left: -1px;
                padding: 3px 7px;
                font-size: 12px;
                font-weight: bold;
                background-color: #f5f5f5;
                border: 1px solid #ddd;
                color: #9da0a4;
                -webkit-border-radius: 4px 0 4px 0;
                -moz-border-radius: 4px 0 4px 0;
                border-radius: 4px 0 4px 0;
            }

            .cascading-dropdown-loading {
                cursor: wait;
                background: url("res/ajax-loader.gif") 85% center no-repeat transparent;
            }
        </style>

    </head>
    <body>
        <div class="container">
            <div class="page-header">
                <h1>jQuery Cascading Dropdown <small>Examples</small></h1>
            </div>

            
           

            <h4>Dynamic</h4>
            

            <div id="example2" class="bs-docs-example">
                <h4>Phone finder</h4>
<!--
                <select class="step1" name="sido">
                    <option value="">시/도</option>
                </select>
                <select class="step2" name="gungu">
                    <option value="">군/구</option>
                </select>
                <select class="step3" name="dong">
                    <option value="">동</option>
                </select>
-->
                <div>
                    <button data-toggle="dropdown">시/도</button>
                    <ul class="step1">
                        <li></li>
                    </ul>
                </div>
                
                
                <button class="step2">군/구</button><button class="step3">동</button>

                <h4>Matches <img src="res/ajax-loader.gif" data-bind="visible: loading" /></h4>
                <ul data-bind="foreach: apts, visible: apts().length > 0">
                    <li>
                        <span data-bind="text: maker"></span>
                        <span data-bind="text: model"></span>
                    </li>
                </ul>
                <p data-bind="visible: apts().length == 0">No matches</p>
            </div>

            

            <br />

            

        <!-- Scripts here -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/knockout/2.3.0/knockout-min.js"></script>
        <script type="text/javascript" src="res/cate_data.js"></script>
        <script type="text/javascript" src="dist/jquery.cascadingdropdown.min.js"></script>
        <script type="text/javascript">
            function viewmodel() {
                this.apts = ko.observableArray([]);
                this.loading = ko.observable(false);
            }

            var example2 = new viewmodel();

            ko.applyBindings(example2, document.getElementById("example2"));
                       

            // Dynamic
            $("#example2").cascadingDropdown({
                selectBoxes: [
                    {
                        selector: ".step1",
                        source: [
                            { label: "서울시", value: 77 },
                            { label: "경기도", value: 99 },
                        ],
                    },
                    {
                        selector: ".step2",
                        requires: [".step1"],
                        source: function (request, response) {
                            data = subCate[request["sido"]];

                            var selectOnlyOption = data.length <= 1;
                            response(
                                $.map(data, function (item, index) {
                                    return {
                                        label: item.name,
                                        value: item.cate_no,
                                        selected: selectOnlyOption,
                                    };
                                })
                            );
                        },
                    },
                    {
                        selector: ".step3",
                        requires: [".step1", ".step2"],
                        requireAll: true,
                        source: function (request, response) {
                            data = subCate[request["gungu"]];

                            var selectOnlyOption = data.length <= 1;
                            response(
                                $.map(data, function (item, index) {
                                    return {
                                        label: item.name,
                                        value: item.cate_no,
                                        selected: selectOnlyOption,
                                    };
                                })
                            );
                        },
                        
                    },
                    
                ],
                onChange: function (event, dropdownData) {
                    var arr2 = Object.values(dropdownData).filter(function (n) {
                        return n !== "";
                    });
                    var cate_no = arr2[arr2.length - 1];
                    if (cate_no !== undefined) {
                        example2.loading(true);
                        
                        var res_array = [];
                        var offset;

                        for (offset = 0; offset < 1000; offset += 100) {
                            $.ajax({
                                type: "GET",
                                url: "/api/v2/categories/" + cate_no + "/products?display_group=1",
                                data: { offset: offset, limit: 100 },
                                async: false,
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("X-Cafe24-Client-Id", "1mbvODfKbKpc71Z4rs3kgH");
                                    xhr.setRequestHeader("Content-Type", "application/json");
                                },
                                success: function (res) {
                                    var products = res.products                            
                                    for (var i in products) {
                                        res_array.push(products[i]);
                                    }               
                    
                                },
                                error: function (request, status, error) {
                                    console.log(request);
                                },
                            });
                        }
                        console.log("last:", res_array);
                        
                        example2.apts(res_array);
                        example2.loading(false);
                        
                    }
                },
            });

            
    </body>
</html>
